name: Deploy Hindsight to AWS

on:
  push:
    branches:
      - main
    paths:
      - 'cdk/**'
      - '.github/workflows/deploy-hindsight.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod
  release:
    types: [created]

env:
  AWS_REGION: ca-central-1
  PYTHON_VERSION: '3.11'

jobs:
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      id-token: write  # Required for OIDC
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd cdk
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install CDK CLI
        run: npm install -g aws-cdk

      - name: Validate LLM API key
        run: |
          if [ -z "${{ secrets.LLM_API_KEY }}" ]; then
            echo "::error::LLM_API_KEY secret is empty. Add your OpenAI (or provider) API key in repo Secrets."
            exit 1
          fi

      - name: CDK Synth
        run: |
          cd cdk
          cdk synth HindsightDevStack

      - name: CDK Deploy
        run: |
          cd cdk
          cdk deploy HindsightDevStack --require-approval never

      - name: Set LLM API key in Secrets Manager
        run: |
          # Use outputs only after stack has finished (we can't get them before).
          LLM_ARN=$(aws cloudformation describe-stacks \
            --stack-name HindsightDevStack \
            --query 'Stacks[0].Outputs[?OutputKey==`LlmSecretArn`].OutputValue' \
            --output text --region ${{ env.AWS_REGION }})
          if [ -z "$LLM_ARN" ] || [ "$LLM_ARN" = "None" ]; then
            echo "::error::LlmSecretArn not in stack outputs. Check deploy succeeded."
            exit 1
          fi
          aws secretsmanager put-secret-value \
            --secret-id "$LLM_ARN" \
            --secret-string "${{ secrets.LLM_API_KEY }}" \
            --region ${{ env.AWS_REGION }}
          echo "✓ LLM API key stored in Secrets Manager"

      - name: Force ECS Hindsight API redeploy
        run: |
          SVC_ARN=$(aws cloudformation describe-stack-resources --stack-name HindsightDevStack \
            --region ${{ env.AWS_REGION }} --query 'StackResources[?contains(LogicalResourceId, `HindsightApiService`) && ResourceType==`AWS::ECS::Service`].PhysicalResourceId' --output text | head -1)
          if [ -n "$SVC_ARN" ] && [ "$SVC_ARN" != "None" ]; then
            CLUSTER=$(echo "$SVC_ARN" | cut -d'/' -f2)
            SERVICE=$(basename "$SVC_ARN")
            aws ecs update-service --cluster "$CLUSTER" --service "$SERVICE" --force-new-deployment --region ${{ env.AWS_REGION }}
            echo "✓ New Hindsight API tasks will pick up updated LLM key"
          fi

      - name: Verify Database URL Secret (CDK Lambda should have populated it)
        run: |
          DB_URL_SECRET_ARN=$(aws cloudformation describe-stacks \
            --stack-name HindsightDevStack \
            --query 'Stacks[0].Outputs[?OutputKey==`DbUrlSecretArn`].OutputValue' \
            --output text --region ${{ env.AWS_REGION }} || echo "")
          if [ -n "$DB_URL_SECRET_ARN" ] && [ "$DB_URL_SECRET_ARN" != "None" ]; then
            DB_URL=$(aws secretsmanager get-secret-value \
              --secret-id "$DB_URL_SECRET_ARN" \
              --query 'SecretString' \
              --output text --region ${{ env.AWS_REGION }} || echo "")
            if [ -n "$DB_URL" ] && [ "$DB_URL" != "None" ]; then
              echo "✓ Database URL secret is populated (by CDK Lambda)"
            else
              echo "⚠ Warning: Database URL secret exists but is empty. Check CloudFormation for DbUrlResource/PgvectorResource errors."
            fi
          else
            echo "⚠ Warning: DbUrlSecretArn not found in outputs."
          fi

  deploy-prod:
    name: Deploy to Prod
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    permissions:
      id-token: write  # Required for OIDC
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name || github.ref }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd cdk
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install CDK CLI
        run: npm install -g aws-cdk

      - name: Validate LLM API key
        run: |
          if [ -z "${{ secrets.LLM_API_KEY }}" ]; then
            echo "::error::LLM_API_KEY secret is empty. Add your OpenAI (or provider) API key in repo Secrets."
            exit 1
          fi

      - name: CDK Synth
        run: |
          cd cdk
          cdk synth HindsightProdStack

      - name: CDK Deploy
        run: |
          cd cdk
          cdk deploy HindsightProdStack --require-approval never

      - name: Set LLM API key in Secrets Manager
        run: |
          LLM_ARN=$(aws cloudformation describe-stacks \
            --stack-name HindsightProdStack \
            --query 'Stacks[0].Outputs[?OutputKey==`LlmSecretArn`].OutputValue' \
            --output text --region ${{ env.AWS_REGION }})
          if [ -z "$LLM_ARN" ] || [ "$LLM_ARN" = "None" ]; then
            echo "::error::LlmSecretArn not in stack outputs. Check deploy succeeded."
            exit 1
          fi
          aws secretsmanager put-secret-value \
            --secret-id "$LLM_ARN" \
            --secret-string "${{ secrets.LLM_API_KEY }}" \
            --region ${{ env.AWS_REGION }}
          echo "✓ LLM API key stored in Secrets Manager"

      - name: Force ECS Hindsight API redeploy
        run: |
          SVC_ARN=$(aws cloudformation describe-stack-resources --stack-name HindsightProdStack \
            --region ${{ env.AWS_REGION }} --query 'StackResources[?contains(LogicalResourceId, `HindsightApiService`) && ResourceType==`AWS::ECS::Service`].PhysicalResourceId' --output text | head -1)
          if [ -n "$SVC_ARN" ] && [ "$SVC_ARN" != "None" ]; then
            CLUSTER=$(echo "$SVC_ARN" | cut -d'/' -f2)
            SERVICE=$(basename "$SVC_ARN")
            aws ecs update-service --cluster "$CLUSTER" --service "$SERVICE" --force-new-deployment --region ${{ env.AWS_REGION }}
            echo "✓ New Hindsight API tasks will pick up updated LLM key"
          fi

      - name: Verify Database URL Secret (CDK Lambda should have populated it)
        run: |
          DB_URL_SECRET_ARN=$(aws cloudformation describe-stacks \
            --stack-name HindsightProdStack \
            --query 'Stacks[0].Outputs[?OutputKey==`DbUrlSecretArn`].OutputValue' \
            --output text --region ${{ env.AWS_REGION }} || echo "")
          if [ -n "$DB_URL_SECRET_ARN" ] && [ "$DB_URL_SECRET_ARN" != "None" ]; then
            DB_URL=$(aws secretsmanager get-secret-value \
              --secret-id "$DB_URL_SECRET_ARN" \
              --query 'SecretString' \
              --output text --region ${{ env.AWS_REGION }} || echo "")
            if [ -n "$DB_URL" ] && [ "$DB_URL" != "None" ]; then
              echo "✓ Database URL secret is populated (by CDK Lambda)"
            else
              echo "⚠ Warning: Database URL secret exists but is empty. Check CloudFormation for DbUrlResource/PgvectorResource errors."
            fi
          else
            echo "⚠ Warning: DbUrlSecretArn not found in outputs."
          fi
