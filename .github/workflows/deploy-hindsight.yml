name: Deploy Hindsight to AWS

on:
  push:
    branches:
      - main
    paths:
      - 'cdk/**'
      - '.github/workflows/deploy-hindsight.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - prod
  release:
    types: [created]

env:
  AWS_REGION: ca-central-1
  PYTHON_VERSION: '3.11'

jobs:
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      id-token: write  # Required for OIDC
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd cdk
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install CDK CLI
        run: npm install -g aws-cdk

      - name: Validate LLM API key
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        run: |
          if [ -z "$LLM_API_KEY" ]; then
            echo "::error::LLM_API_KEY secret is empty. Add your OpenAI (or provider) API key in repo Secrets."
            exit 1
          fi
          # Must look like an OpenAI key (sk- or sk-proj-) so we never overwrite with RDS password / DB URL etc.
          if ! python3 -c "import os; s=os.environ.get('LLM_API_KEY',''); exit(0 if (s.startswith('sk-') or s.startswith('sk-proj-')) else 1)"; then
            echo "::error::LLM_API_KEY must start with 'sk-' or 'sk-proj-' (OpenAI key). If you use another provider, update config.py and this check."
            exit 1
          fi

      - name: CDK Synth
        run: |
          cd cdk
          cdk synth HindsightDevStack

      - name: CDK Deploy
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        run: |
          cd cdk
          # Pass LLM API key via CDK context so it's populated during stack creation
          # This ensures the secret is ready BEFORE ECS tasks start
          cdk deploy HindsightDevStack --require-approval never --context llm_api_key="$LLM_API_KEY"

      - name: Verify Database URL Secret (CDK Lambda should have populated it)
        run: |
          DB_URL_SECRET_ARN=$(aws cloudformation describe-stacks \
            --stack-name HindsightDevStack \
            --query 'Stacks[0].Outputs[?OutputKey==`DbUrlSecretArn`].OutputValue' \
            --output text --region ${{ env.AWS_REGION }} || echo "")
          if [ -n "$DB_URL_SECRET_ARN" ] && [ "$DB_URL_SECRET_ARN" != "None" ]; then
            DB_URL=$(aws secretsmanager get-secret-value \
              --secret-id "$DB_URL_SECRET_ARN" \
              --query 'SecretString' \
              --output text --region ${{ env.AWS_REGION }} || echo "")
            if [ -n "$DB_URL" ] && [ "$DB_URL" != "None" ]; then
              echo "✓ Database URL secret is populated (by CDK Lambda)"
            else
              echo "⚠ Warning: Database URL secret exists but is empty. Check CloudFormation for DbUrlResource/PgvectorResource errors."
            fi
          else
            echo "⚠ Warning: DbUrlSecretArn not found in outputs."
          fi

  deploy-prod:
    name: Deploy to Prod
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    permissions:
      id-token: write  # Required for OIDC
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name || github.ref }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_PROD }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd cdk
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install CDK CLI
        run: npm install -g aws-cdk

      - name: Validate LLM API key
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        run: |
          if [ -z "$LLM_API_KEY" ]; then
            echo "::error::LLM_API_KEY secret is empty. Add your OpenAI (or provider) API key in repo Secrets."
            exit 1
          fi
          # Must look like an OpenAI key (sk- or sk-proj-) so we never overwrite with RDS password / DB URL etc.
          if ! python3 -c "import os; s=os.environ.get('LLM_API_KEY',''); exit(0 if (s.startswith('sk-') or s.startswith('sk-proj-')) else 1)"; then
            echo "::error::LLM_API_KEY must start with 'sk-' or 'sk-proj-' (OpenAI key). If you use another provider, update config.py and this check."
            exit 1
          fi

      - name: CDK Synth
        run: |
          cd cdk
          cdk synth HindsightProdStack

      - name: CDK Deploy
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        run: |
          cd cdk
          # Pass LLM API key via CDK context so it's populated during stack creation
          # This ensures the secret is ready BEFORE ECS tasks start
          cdk deploy HindsightProdStack --require-approval never --context llm_api_key="$LLM_API_KEY"

      - name: Verify Database URL Secret (CDK Lambda should have populated it)
        run: |
          DB_URL_SECRET_ARN=$(aws cloudformation describe-stacks \
            --stack-name HindsightProdStack \
            --query 'Stacks[0].Outputs[?OutputKey==`DbUrlSecretArn`].OutputValue' \
            --output text --region ${{ env.AWS_REGION }} || echo "")
          if [ -n "$DB_URL_SECRET_ARN" ] && [ "$DB_URL_SECRET_ARN" != "None" ]; then
            DB_URL=$(aws secretsmanager get-secret-value \
              --secret-id "$DB_URL_SECRET_ARN" \
              --query 'SecretString' \
              --output text --region ${{ env.AWS_REGION }} || echo "")
            if [ -n "$DB_URL" ] && [ "$DB_URL" != "None" ]; then
              echo "✓ Database URL secret is populated (by CDK Lambda)"
            else
              echo "⚠ Warning: Database URL secret exists but is empty. Check CloudFormation for DbUrlResource/PgvectorResource errors."
            fi
          else
            echo "⚠ Warning: DbUrlSecretArn not found in outputs."
          fi
