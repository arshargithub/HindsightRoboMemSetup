# HindsightRoboMemSetup

Infrastructure-as-code (AWS CDK) for deploying [Hindsight](https://hindsight.vectorize.io) memory service on AWS for the Johnny robot.

## What This Repo Contains

- **CDK (Python)** code to deploy Hindsight on AWS (VPC, RDS, ECS, ALB, Lambda, EventBridge)
- **GitHub Actions** workflow for automated deployment
- **Dev + Prod** environments with tag/release-based promotion to prod

## Quick Start

1. **Set up AWS OIDC** (see [`docs/SETUP_OIDC.md`](docs/SETUP_OIDC.md))
2. **Add GitHub Secrets** (see [`docs/SETUP_OIDC.md`](docs/SETUP_OIDC.md))
3. **Bootstrap CDK** (first time only):
   ```bash
   cd cdk
   python -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   npm install -g aws-cdk
   cdk bootstrap aws://ACCOUNT-ID/ca-central-1
   ```
4. **Push to `main`** → Auto-deploys to **dev**
5. **Create a GitHub Release** → Auto-deploys to **prod**

## Architecture

See [`docs/AWS_HINDSIGHT_ARCHITECTURE.md`](docs/AWS_HINDSIGHT_ARCHITECTURE.md) for full details.

**Components:**
- **VPC** with public/private subnets, NAT Gateway
- **RDS PostgreSQL** with pgvector extension
- **ECS Fargate** running Hindsight API
- **ALB** for HTTPS access
- **Lambda + EventBridge** for scheduled Reflect jobs
- **Secrets Manager** for credentials

## Deployment

### Dev (Automatic)

- **Trigger**: Push to `main` branch
- **Workflow**: `.github/workflows/deploy-hindsight.yml`
- **Stack**: `HindsightDevStack`

### Prod (Tag/Release-based)

- **Trigger**: Create a GitHub Release (or tag)
- **Workflow**: Same workflow, different job
- **Stack**: `HindsightProdStack`

**To promote to prod:**
1. Ensure `main` is ready
2. Create a GitHub Release (or tag)
3. Workflow automatically deploys to prod

## Project Structure

```
.
├── cdk/                    # CDK Python code
│   ├── app.py             # CDK app entry point
│   ├── hindsight_stack.py # Main infrastructure stack
│   ├── config.py          # Environment configuration
│   └── requirements.txt   # Python dependencies
├── docs/                   # Documentation
│   ├── AWS_HINDSIGHT_ARCHITECTURE.md
│   ├── SETUP_OIDC.md
│   └── DATABASE_URL_SETUP.md
└── .github/workflows/      # GitHub Actions
    └── deploy-hindsight.yml
```

## Local Development

```bash
# Install dependencies
cd cdk
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
npm install -g aws-cdk

# List stacks
cdk list

# Synthesize CloudFormation
cdk synth HindsightDevStack

# Deploy
cdk deploy HindsightDevStack

# View differences
cdk diff HindsightDevStack
```

## Configuration

Edit `cdk/config.py` to adjust:
- AWS region
- RDS instance size
- ECS task CPU/memory
- Reflect schedule frequency
- **LLM provider and model** (`LLM_PROVIDER`, `LLM_MODEL`) — e.g. `openai` / `gpt-4o-mini`, or `groq` / `openai/gpt-oss-20b`. The API key in GitHub Secrets must match the provider you choose.
- etc.

## Secrets

- **RDS password**: Auto-generated by CDK, stored in Secrets Manager
- **LLM API key**: Set via GitHub Secret `LLM_API_KEY`, synced to Secrets Manager by workflow
  - **IMPORTANT**: The LLM API key secret is created empty and MUST be populated before ECS tasks start.
  - GitHub Actions workflow automatically populates it from `LLM_API_KEY` secret.
  - For manual deployments, populate it manually:
    ```bash
    aws secretsmanager put-secret-value \
      --secret-id <LlmSecretArn> \
      --secret-string <your-api-key>
    ```
  - Without a valid API key, Hindsight API tasks will fail with 401 errors during startup.

## Outputs

After deployment, CDK outputs:
- **HindsightApiUrl**: API endpoint URL
- **ControlPlaneUrl**: Control Plane (Web UI) URL
- **RdsEndpoint**: RDS PostgreSQL endpoint
- **RdsSecretArn**: RDS password secret ARN
- **LlmSecretArn**: LLM API key secret ARN

## References

- [Hindsight Documentation](https://hindsight.vectorize.io)
- [AWS CDK Documentation](https://docs.aws.amazon.com/cdk/)
- [GitHub Actions OIDC](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services)
